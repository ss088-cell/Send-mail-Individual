<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* Set the font to Trebuchet MS */
      body {
        font-family: "Trebuchet MS", sans-serif;
        background-color: skyblue; /* Sky blue background */
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Center the main content */
      #content {
        text-align: center;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      /* Style the email preview popup as a toast */
      #emailPreview, #toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        width: 300px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        display: none;
      }

      /* Style the preview fields */
      #emailPreview p {
        margin: 5px 0;
      }

      /* Add a button style */
      button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      /* Close the preview */
      .close-btn {
        background-color: #f44336;
      }

      /* Input fields for email editing */
      input[type="text"], textarea {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
        box-sizing: border-box;
      }
    </style>
    <script>
      // Function to handle the form submission
      function handleSubmit() {
        const sheetUrl = document.getElementById("sheetUrl").value;

        // Validate if the user entered a Google Sheet URL
        if (!sheetUrl) {
          alert('Please provide a Google Sheet URL.');
          return;
        }

        // Call the Apps Script function to fetch email details and preview the email
        google.script.run
          .withSuccessHandler(function(emailDetails) {
            if (!emailDetails) {
              alert('No email details found for the provided report.');
              return;
            }

            // Display the email details in editable fields
            document.getElementById('previewTo').value = emailDetails.to;
            document.getElementById('previewCc').value = emailDetails.cc;
            document.getElementById('previewSubject').value = emailDetails.subject;
            document.getElementById('previewBody').value = emailDetails.body;

            // Show the email preview popup
            document.getElementById('emailPreview').style.display = 'block';
          })
          .fetchEmailDetails(sheetUrl); // Call to the backend
      }

      // Function to send the email
      function sendEmail() {
        const sheetUrl = document.getElementById("sheetUrl").value;

        // Capture the modified email details
        const emailDetails = {
          to: document.getElementById('previewTo').value,
          cc: document.getElementById('previewCc').value,
          subject: document.getElementById('previewSubject').value,
          body: document.getElementById('previewBody').value
        };

        // Call the Apps Script function to send the email with updated details
        google.script.run
          .withSuccessHandler(function(result) {
            if (result) {
              // Show toast message when email is successfully sent
              document.getElementById('toast').innerText = 'Mail Sent!\nRefresh to send another mail';
              document.getElementById('toast').style.display = 'block';
              setTimeout(function() {
                document.getElementById('toast').style.display = 'none';
              }, 3000);

              // Clear the form and email preview data after sending
              document.getElementById('sheetUrl').value = '';
              document.getElementById('previewTo').value = '';
              document.getElementById('previewCc').value = '';
              document.getElementById('previewSubject').value = '';
              document.getElementById('previewBody').value = '';

            } else {
              alert('Failed to send the email.');
            }
          })
          .sendReportEmail(sheetUrl, emailDetails); // Pass the updated email details

        // Close the email preview popup
        document.getElementById('emailPreview').style.display = 'none';
      }

      // Function to close the email preview toast
      function closePreview() {
        document.getElementById('emailPreview').style.display = 'none';
      }
    </script>
  </head>
  <body>
    <div id="content">
      <h1>Email Report Sender</h1>

      <!-- Input for Google Sheet Report URL -->
      <label for="sheetUrl">Enter Google Sheet Report URL:</label><br>
      <input type="text" id="sheetUrl" placeholder="Paste your Google Sheet URL here" style="width: 400px;"><br><br>

      <!-- Submit button to fetch email details -->
      <button onclick="handleSubmit()">Submit</button>
    </div>

    <!-- Email preview popup (as toast, initially hidden) -->
    <div id="emailPreview">
      <h2>Email Preview (Editable)</h2>
      <label><strong>To:</strong></label>
      <input type="text" id="previewTo"><br>
      <label><strong>CC:</strong></label>
      <input type="text" id="previewCc"><br>
      <label><strong>Subject:</strong></label>
      <input type="text" id="previewSubject"><br>
      <label><strong>Body:</strong></label>
      <textarea id="previewBody" rows="5"></textarea><br>

      <!-- Button to send the email -->
      <button onclick="sendEmail()">Send Email</button>
      <button class="close-btn" onclick="closePreview()">Close</button>
    </div>

    <!-- Toast message for email sent notification -->
    <div id="toast"></div>
  </body>
</html>
