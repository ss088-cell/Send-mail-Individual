<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: "Trebuchet MS", sans-serif;
        background-color: skyblue;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #content {
        text-align: center;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      #emailPreview, #toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        width: 400px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        display: none;
      }

      #emailPreview p {
        margin: 5px 0;
      }

      button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      .close-btn {
        background-color: #f44336;
      }

      input[type="text"], textarea {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
        box-sizing: border-box;
      }
    </style>
    <script>
      function handleSubmit() {
        const sheetUrl = document.getElementById("sheetUrl").value;

        if (!sheetUrl) {
          alert('Please provide a Google Sheet URL.');
          return;
        }

        google.script.run
          .withSuccessHandler(function(emailDetails) {
            if (!emailDetails) {
              alert('No email details found for the provided report.');
              return;
            }

            document.getElementById('previewTo').value = emailDetails.to;
            document.getElementById('previewCc').value = emailDetails.cc;
            document.getElementById('previewSubject').value = emailDetails.subject;
            document.getElementById('previewBody').value = emailDetails.body;

            document.getElementById('emailPreview').style.display = 'block';
          })
          .fetchEmailDetails(sheetUrl);
      }

      function sendEmail() {
        const sheetUrl = document.getElementById("sheetUrl").value;

        const emailDetails = {
          to: document.getElementById('previewTo').value,
          cc: document.getElementById('previewCc').value,
          subject: document.getElementById('previewSubject').value,
          body: document.getElementById('previewBody').value
        };

        google.script.run
          .withSuccessHandler(function(result) {
            if (result) {
              document.getElementById('toast').innerText = 'Mail Sent!\nRefresh to send another mail';
              document.getElementById('toast').style.display = 'block';
              setTimeout(function() {
                document.getElementById('toast').style.display = 'none';
              }, 3000);

              document.getElementById('sheetUrl').value = '';
              document.getElementById('previewTo').value = '';
              document.getElementById('previewCc').value = '';
              document.getElementById('previewSubject').value = '';
              document.getElementById('previewBody').value = '';
            } else {
              alert('Failed to send the email.');
            }
          })
          .sendReportEmail(sheetUrl, emailDetails);

        document.getElementById('emailPreview').style.display = 'none';
      }

      function closePreview() {
        document.getElementById('emailPreview').style.display = 'none';
      }
    </script>
  </head>
  <body>
    <div id="content">
      <h1>Email Report Sender</h1>

      <label for="sheetUrl">Enter Google Sheet Report URL:</label><br>
      <input type="text" id="sheetUrl" placeholder="Paste your Google Sheet URL here" style="width: 400px;"><br><br>

      <button onclick="handleSubmit()">Submit</button>
    </div>

    <div id="emailPreview">
      <h2>Email Preview (Editable)</h2>
      <label><strong>To:</strong></label>
      <input type="text" id="previewTo"><br>
      <label><strong>CC:</strong></label>
      <input type="text" id="previewCc"><br>
      <label><strong>Subject:</strong></label>
      <input type="text" id="previewSubject"><br>
      <label><strong>Body:</strong></label>
      <textarea id="previewBody" rows="7"></textarea><br>

      <button onclick="sendEmail()">Send Email</button>
      <button class="close-btn" onclick="closePreview()">Close</button>
    </div>

    <div id="toast"></div>
  </body>
</html>
